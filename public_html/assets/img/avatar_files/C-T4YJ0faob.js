/*!CK:3492012720!*//*1428289582,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["+GdDw"]); }

__d("getTextAfterNearestEntity",[],function(a,b,c,d,e,f){b.__markCompiled&&b.__markCompiled();function g(h,i){var j=i;while(j>0&&h.getEntityAt(j-1)===null)j--;return h.getText().slice(j,i);}e.exports=g;},null);
__d("applyEmoticonToContentBlock",["CharacterMetadata","ComposedEntityMutability","ComposedEntityType","DocumentEntity","EmoticonsList","immutable"],function(a,b,c,d,e,f,g,h,i,j,k,l){b.__markCompiled&&b.__markCompiled();'use strict';var m=l,n=m.List,o='\u3000';function p(q,r,s){if(!k.emotes[r])return q;var t=j.create(i.EMOTICON,h.IMMUTABLE,{type:k.emotes[r],originalEmoticon:r}),u=q.getText(),v=q.getCharacterList(),w=r.length,x=v.get(s);return q.merge({text:(u.slice(0,s)+o+u.slice(s+w)),characterList:v.slice(0,s).concat(n.of(g.applyEntity(x,t)),v.slice(s+w))});}e.exports=p;},null);
__d("applyEmoticonToContentState",["EmoticonsList","applyEmoticonToContentBlock","getTextAfterNearestEntity"],function(a,b,c,d,e,f,g,h,i){b.__markCompiled&&b.__markCompiled();'use strict';var j=new RegExp(g.regexp.source,'g');function k(l,m){var n=m.getAnchorKey(),o=m.getAnchorOffset(),p=l.getBlockForKey(n),q=i(p,o),r,s;while(s!==null){s=j.exec(q);if(s!==null)r=s;}if(!r)return l;var t=r[1];if(!t&&o!==q.length)return l;var u=r[2],v=o-q.length,w=v+r.index+r[1].length,x=l.getBlockMap().set(n,h(p,u,w));o-=(u.length-1);return l.merge({blockMap:x,selectionBefore:m,selectionAfter:m.merge({anchorOffset:o,focusOffset:o})});}e.exports=k;},null);
__d("insertEmoticonIntoContentState",["DocumentModifier","applyEmoticonToContentBlock"],function(a,b,c,d,e,f,g,h){b.__markCompiled&&b.__markCompiled();'use strict';function i(j,k,l){var m=g.replaceText(k,l,j),n=l.getAnchorKey(),o=l.getAnchorOffset(),p=m.getBlockForKey(n),q=m.getBlockMap().set(n,h(p,j,o));o++;return k.merge({blockMap:q,selectionBefore:l,selectionAfter:l.merge({anchorOffset:o,focusOffset:o})});}e.exports=i;},null);
__d("insertEmoticonIntoEditorState",["DocumentModifier","EditorChangeType","EditorState","insertEmoticonIntoContentState"],function(a,b,c,d,e,f,g,h,i,j){b.__markCompiled&&b.__markCompiled();'use strict';var k=' ';function l(m,n){var o=n.getSelection(),p=n.getCurrentContent(),q=o.getStartOffset(),r=o.getEndOffset(),s=p.getBlockForKey(o.getStartKey()).getText(),t=p.getBlockForKey(o.getEndKey()).getText(),u='';if(r<=t.length&&t[r]!==k)u=k;if(q>0&&s[q-1]!==k){p=g.insertText(p,o,k);o=p.getSelectionAfter();}var v=j(m,p,o);p=g.insertText(v,v.getSelectionAfter(),u);return i.push(n,p,h.INSERT_CHARACTERS);}e.exports=l;},null);
__d("handleBeforeInputForEmoticon",["DocumentModifier","EditorChangeType","EditorState","applyEmoticonToContentState"],function(a,b,c,d,e,f,g,h,i,j){b.__markCompiled&&b.__markCompiled();var k=new RegExp(/[\s'".,!?]/);function l(m,n){var o=m.getSelection();if(!o.isCollapsed()||!n||!k.test(n))return m;var p=m.getCurrentContent(),q=j(p,o);if(q===p)return m;var r=g.insertText(q,q.getSelectionAfter(),n);return i.push(m,r,h.INSERT_CHARACTERS);}e.exports=l;},null);
__d("handleSoftNewlineForEmoticon",["DocumentModifier","EditorChangeType","EditorState","applyEmoticonToContentState"],function(a,b,c,d,e,f,g,h,i,j){b.__markCompiled&&b.__markCompiled();function k(l){var m=l.getCurrentContent(),n=l.getSelection(),o=j(m,n);if(o===m)return l;var p=g.splitBlock(o,o.getSelectionAfter());return i.push(l,p,h.SPLIT_BLOCK);}e.exports=k;},null);
__d("isSoftNewlineEvent",["Keys"],function(a,b,c,d,e,f,g){b.__markCompiled&&b.__markCompiled();function h(i){return i.which===g.RETURN&&(i.getModifierState('Shift')||i.getModifierState('Alt')||i.getModifierState('Control'));}e.exports=h;},null);
__d("StickerTriggerHighlightSpan.react",["EmoticonSpan.react","React","Toggler","cx"],function(a,b,c,d,e,f,g,h,i,j){b.__markCompiled&&b.__markCompiled();'use strict';var k=h,l=k.PropTypes,m=h.createClass({displayName:"StickerTriggerHighlightSpan",getInitialState:function(){return {activated:false};},propTypes:{offsetKey:l.string,searchTriggeredWord:l.func,stickersFlyoutToggler:l.object},componentDidMount:function(){this._togglerSub=i.listen('hide',this.props.stickersFlyoutToggler,function(){return this.isMounted()&&this.setState({activated:false});}.bind(this));},componentWillUnmount:function(){this._togglerSub&&this._togglerSub.unsubscribe();},_onClick:function(){if(this.state.activated)return;this.props.searchTriggeredWord();this.setState({activated:true});},render:function(){var n;if(this.props.entityKey){n=h.createElement(g,h.__spread({},this.props));}else n=this.props.children;return (h.createElement("span",{onClick:this._onClick,"data-offset-key":this.props.offsetKey,className:(("_29dt")+(this.state.activated?' '+"_1t57":'')),spellCheck:false},n));}});e.exports=m;},null);
__d("ChatInput.react",["AbstractMentionsTextEditor.react","Bootloader","ChatConfig","ComposedEntityType","DocumentCompositeDecorator","DocumentDecorator","DocumentModifier","EditorChangeType","EditorState","EmoticonSpan.react","MentionSpan.react","MentionsInputTypeaheadView.react","MentionsLayer.react","StickerTriggerHighlightSpan.react","React","createContentStateFromBlocks","createInitialEditorState","createMentionEntity","createPlainBlocksFromText","emptyFunction","getDefaultKeyBinding","getEntityMatcher","getVisibleValueForContentState","handleBeforeInputForEmoticon","handleSoftNewlineForEmoticon","insertEmoticonIntoEditorState","isSoftNewlineEvent","setImmediate"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,aa,ba,ca,da,ea,fa,ga,ha){b.__markCompiled&&b.__markCompiled();'use strict';var ia=u,ja=ia.PropTypes,ka=z.thatReturnsNull,la=j.EMOTICON,ma=j.MENTION,na=u.createClass({displayName:"ChatInput",propTypes:{blockStyleFn:ja.func,initializeThingsWithInputFn:ja.func,inlineStyleFn:ja.func,inputChanged:ja.func,inputKeyDown:ja.func,keyBindingFn:ja.func,onAddMention:ja.func,onBlur:ja.func,onEscape:ja.func,onFocus:ja.func,onTab:ja.func,resizeFn:ja.func,searchTriggeredWord:ja.func,stickersFlyoutToggler:ja.object},getDefaultProps:function(){return {blockStyleFn:ka,inlineStyleFn:ka,keyBindingFn:aa};},componentDidMount:function(){this._oldHeight=u.findDOMNode(this).getBoundingClientRect().height;this.props.resizeFn(this._oldHeight);this.props.initializeThingsWithInputFn(u.findDOMNode(this.refs.input),this.getValue);this.setState({triggeredWord:this.props.triggeredWord});if(i.get('chat_mentions_entities'))h.loadModules(["AtSignMentionsStrategy","CurrentUser","DocumentCompositeMentionsSource","DocumentMentionsSource","SearchSourceWithMetrics","TypeaheadMetricReporter","URI","WebAsyncSearchSource"],function(oa,pa,qa,ra,sa,ta,ua,va){var wa=new ta({event_name:'chat_mentions_entities'}),xa=new sa(new va({queryRequests:[{uri:ua('/ajax/typeahead/search.php'),data:{viewer:pa.getID(),filter:i.get('chat_mentions_types')}}],bootstrapRequests:[{uri:ua('/ajax/typeahead/first_degree.php'),data:{viewer:pa.getID(),filter:i.get('chat_mentions_types')}}]}),wa),ya=new qa([new ra(oa,xa)]);ya.bootstrap();wa.sessionStart();this.setState({mentionsSource:ya,typeaheadReporter:wa});}.bind(this));},componentWillReceiveProps:function(oa){if(this.state.triggeredWord!==oa.triggeredWord)this.setState({triggeredWord:oa.triggeredWord},this._updateDecorator);},componentDidUpdate:function(){ha(function(){var oa=u.findDOMNode(this).getBoundingClientRect().height;if(this._oldHeight!==oa)this.props.resizeFn(oa);this._oldHeight=oa;}.bind(this));},getInitialState:function(){return {editorState:this._createEmptyEditorState()};},_createEmptyEditorState:function(){var oa=y(['']);return w(v(oa),this._getStickerTagDecorator());},resetState:function(){if(this.state.typeaheadReporter){this.state.typeaheadReporter.sessionEnd();this.state.typeaheadReporter.sessionStart();}this.setState({editorState:o.moveFocusToEnd(this._createEmptyEditorState()),triggeredWord:null});},_updateDecorator:function(){var oa=this._getStickerTagDecorator();ha(function(){var pa=o.set(this.state.editorState,{decorator:oa});this.setState({editorState:pa});}.bind(this));},_getStickerTagDecorator:function(){var oa=this.state&&this.state.triggeredWord,pa=function(ra,sa){if(!oa)return;var ta,ua,va;if(oa.match(/\W/)){va=new RegExp(oa.replace(/(\W)/g,'\\$1'),'gi');}else va=new RegExp('\\b'+oa+'\\b','gi');while((ta=va.exec(ra.getText()))!==null){ua=ta.index;sa(ua,ua+oa.length);}},qa={stickersFlyoutToggler:this.props.stickersFlyoutToggler,searchTriggeredWord:this.props.searchTriggeredWord};return new k([new l(pa,t,qa),new l(ba(function(ra){return (ra.getType()===la&&ra.getData().originalEmoticon===oa);}),t,qa),new l(ba(function(ra){return ra.getType()===la;}),p),new l(ba(function(ra){return ra.getType()===ma;}),q)]);},onChange:function(oa){if(oa.getCurrentContent()!==this.state.editorState.getCurrentContent())this.props.inputChanged(this.getValueFromEditorState(oa));this.setState({editorState:oa});},onReturn:function(event){if(ga(event)){var oa=ea(this.state.editorState);if(oa===this.state.editorState)return false;this.setState({editorState:oa});return true;}this.props.inputKeyDown(event,this.getValue());this.resetState();return true;},_onAddMention:function(oa){if(this.state.typeaheadReporter)this.state.typeaheadReporter.reportSelect(oa.getUniqueID(),oa.getType(),0,false);this.props.onAddMention&&this.props.onAddMention(oa);},_onShowMentions:function(oa,pa){this.state.typeaheadReporter&&this.state.typeaheadReporter.reportResults(oa.map(function(qa){return qa.getUniqueID();}));},getValueFromEditorState:function(oa){var pa=oa.getCurrentContent();return ca(pa);},getValue:function(){return this.getValueFromEditorState(this.state.editorState);},focus:function(){this.refs.input.focus();},_handleBeforeInput:function(oa){var pa=da(this.state.editorState,oa);if(pa===this.state.editorState)return false;this.setState({editorState:pa});return true;},_handleFiles:function(oa){var pa=/^image\//,qa=oa.filter(function(ra){return pa.test(ra.type);});if(qa.length){this.props.uploadPhotoFn(qa[0]);return true;}return false;},_handlePastedFiles:function(oa){return this._handleFiles(oa);},_handleDroppedFiles:function(oa,pa){return this._handleFiles(pa);},insertEmoticon:function(oa){var pa=fa(oa,this.state.editorState);if(pa!==this.state.editorState)this.setState({editorState:pa});},appendText:function(oa){var pa=this.state.editorState,qa=pa.getSelection(),ra=pa.getCurrentContent();ra=m.insertText(ra,qa,oa);pa=o.push(pa,ra,n.INSERT_CHARACTERS);this.setState({editorState:pa});},render:function(){return (u.createElement(g,u.__spread({ref:"input"},this.props,{editorState:this.state.editorState,onChange:this.onChange,onAddMention:this._onAddMention,onShowMentions:this._onShowMentions,handleBeforeInput:this._handleBeforeInput,handlePastedFiles:this._handlePastedFiles,handleDroppedFiles:this._handleDroppedFiles,handleContentReturn:this.onReturn,spellCheck:true,mentionCreationFn:x,mentionResultsComponent:s,mentionResultsProps:{typeaheadView:r,autoflip:true},mentionsSource:this.state.mentionsSource})));}});e.exports=na;},null);